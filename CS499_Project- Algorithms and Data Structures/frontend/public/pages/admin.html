<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Admin Panel</h1>
    </div>

    <div class="section">
      <h2>All Users</h2>
      <div id="usersList">Loading users...</div>
    </div>

    <div class="section">
      <h2>All Items</h2>
      <div id="itemsList">Loading items...</div>
    </div>

    <hr>
    <button id="logoutBtn" class="btn-danger">Logout</button><br><br>
    <div><a href="/pages/dashboard.html">Go to User Dashboard</a></div>
  </div>

  <script type="module">
    import ApiService from '/services/api.js';
    import { getUser, isAdmin, clearAuth, isAuthenticated } from '/services/auth.js';
    import { ROUTES } from '/utils/constants.js';

    // Check authentication and admin role
    if (!isAuthenticated()) {
      window.location.href = ROUTES.LOGIN;
    }

    const user = getUser();
    if (!isAdmin()) {
      alert("Admins only!");
      window.location.href = ROUTES.DASHBOARD;
    }

    async function loadUsers() {
      try {
        const users = await ApiService.getUsers();
        const list = document.getElementById("usersList");
        
        if (users.length === 0) {
          list.innerHTML = "<p>No users found</p>";
          return;
        }

        let html = '<ul class="item-list">';
        users.forEach(u => {
          html += `
            <li class="item">
              <div class="item-header">${u.username}</div>
              <div class="item-details">Role: ${u.role}</div>
              <div class="item-details">ID: ${u.id}</div>
              <div class="item-details">Created: ${new Date(u.createdAt).toLocaleDateString()}</div>
            </li>
          `;
        });
        html += '</ul>';
        list.innerHTML = html;
      } catch (error) {
        document.getElementById("usersList").innerHTML = `<div class="error">Error loading users: ${error.message}</div>`;
      }
    }

    async function loadItems() {
      try {
        const items = await ApiService.getAdminItems();
        const list = document.getElementById("itemsList");
        
        if (items.length === 0) {
          list.innerHTML = "<p>No items found</p>";
          return;
        }

        let html = '<ul class="item-list">';
        items.forEach(item => {
          html += `
            <li class="item">
              <div class="item-header">${item.name}</div>
              <div class="item-details">Quantity: ${item.quantity}</div>
              <div class="item-details">Owner: ${item.username}</div>
              <div class="item-details">Created: ${new Date(item.createdAt).toLocaleDateString()}</div>
              <div class="item-actions">
                <button class="btn-danger btn-small delete-item" data-id="${item.id}">Delete</button>
              </div>
            </li>
          `;
        });
        html += '</ul>';
        list.innerHTML = html;

        // Add delete handlers
        document.querySelectorAll('.delete-item').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const itemId = parseInt(e.target.dataset.id);
            if (confirm('Are you sure you want to delete this item?')) {
              try {
                await ApiService.deleteItemAsAdmin(itemId);
                await loadItems(); // Reload
              } catch (error) {
                alert('Error deleting item: ' + error.message);
              }
            }
          });
        });
      } catch (error) {
        document.getElementById("itemsList").innerHTML = `<div class="error">Error loading items: ${error.message}</div>`;
      }
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      clearAuth();
      window.location.href = ROUTES.LOGIN;
    });

    // Load data on page load
    loadUsers();
    loadItems();
  </script>
</body>
</html>